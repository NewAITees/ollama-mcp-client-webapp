flowchart TD
    A[モデル# アプリケーションフロー

このドキュメントでは、Ollama MCP Client & Agent の主要なユーザーフローと画面遷移について説明します。

## 全体的なユーザージャーニー

```mermaid
journey
    title Ollama MCP Client & Agent ユーザージャーニー
    section 初期設定
      環境セットアップ: 3: ユーザー
      Ollamaのインストール: 4: ユーザー
      アプリを起動: 5: ユーザー
    section サーバー接続
      サーバーパスを入力: 3: ユーザー
      サーバーに接続: 4: ユーザー, システム
      利用可能なツールを確認: 5: ユーザー
    section 対話
      クエリを入力: 5: ユーザー
      ツール実行を確認: 4: システム
      結果を受け取る: 5: ユーザー
    section デバッグ
      ログを確認: 3: ユーザー
      問題を特定: 4: ユーザー
      修正する: 3: ユーザー
```

## 主要なユーザーシナリオ

### 1. 初期設定と接続

ユーザーがアプリケーションを初期設定し、MCPサーバーに接続するフロー：

```mermaid
flowchart TD
    A[アプリ起動] --> B{Ollamaが実行中?}
    B -->|はい| C[設定画面表示]
    B -->|いいえ| B1[Ollamaを起動するよう促す]
    B1 --> B
    
    C --> D[サーバー接続設定]
    D --> E{接続情報入力}
    E --> F[サーバーに接続]
    F --> G{接続成功?}
    G -->|はい| H[利用可能なツールを表示]
    G -->|いいえ| G1[エラーメッセージ表示]
    G1 --> E
    
    H --> I[メインインターフェースに遷移]
    
    style A fill:#bbdefb,stroke:#1976d2
    style G1 fill:#ffcdd2,stroke:#c62828
    style I fill:#c8e6c9,stroke:#2e7d32
```

### 2. クエリ処理と対話

ユーザーがシステムと対話し、ツールを使用するフロー：

```mermaid
flowchart TD
    A[メインチャット画面] --> B[ユーザークエリ入力]
    B --> C[クエリ送信]
    C --> D[Ollamaモデル処理]
    D --> E{ツール使用が必要?}
    
    E -->|はい| F[ツールコール実行]
    F --> G[ツール結果取得]
    G --> H[結果をモデルに送信]
    H --> I[最終応答生成]
    
    E -->|いいえ| I
    
    I --> J[応答を表示]
    J --> K{続ける?}
    K -->|はい| B
    K -->|いいえ| L[会話の終了]
    
    style B fill:#bbdefb,stroke:#1976d2
    style F fill:#fff9c4,stroke:#fbc02d
    style J fill:#c8e6c9,stroke:#2e7d32
```

### 3. デバッグと問題解決

開発者がデバッグ情報を利用して問題を解決するフロー：

```mermaid
flowchart TD
    A[問題発生] --> B[デバッグタブに切り替え]
    B --> C[ログレベルを設定]
    C --> D[特定の操作を実行]
    D --> E[ログを確認]
    
    E --> F{問題特定?}
    F -->|いいえ| G[さらに詳細なログを有効化]
    G --> D
    
    F -->|はい| H[問題の修正]
    H --> I[修正を検証]
    I --> J{解決?}
    J -->|いいえ| E
    J -->|はい| K[デバッグを完了]
    
    style A fill:#ffcdd2,stroke:#c62828
    style F fill:#fff9c4,stroke:#fbc02d
    style K fill:#c8e6c9,stroke:#2e7d32
```

### 4. モデルとパラメータの調整

ユーザーがモデルとパラメータを調整するフロー：

```mermaid
flowchart TD
    A[設定タブに移動] --> B[モデル設定を開く]
    B --> C[モデルを選択]
    C --> D[パラメータを調整]
    D --> E[設定を適用]
    E --> F{変更を確認}
    F -->|取り消す| C
    F -->|適用| G[新しい設定で対話を続行]
    
    style C fill:#bbdefb,stroke:#1976d2
    style D fill:#fff9c4,stroke:#fbc02d
    style G fill:#c8e6c9,stroke:#2e7d32
```

## 画面遷移図

アプリケーションの主要な画面とその遷移：

```mermaid
stateDiagram-v2
    [*] --> 起動画面
    起動画面 --> 設定画面: 初回起動
    起動画面 --> メイン画面: 2回目以降
    
    設定画面 --> サーバー接続画面: 接続設定
    サーバー接続画面 --> メイン画面: 接続成功
    サーバー接続画面 --> サーバー接続画面: 接続失敗
    
    state メイン画面 {
        [*] --> チャットタブ
        チャットタブ --> デバッグタブ
        デバッグタブ --> チャットタブ
        チャットタブ --> ツールタブ
        ツールタブ --> チャットタブ
        チャットタブ --> 設定タブ
        設定タブ --> チャットタブ
    }
    
    メイン画面 --> 会話保存ダイアログ: 保存
    会話保存ダイアログ --> メイン画面: 保存完了
    
    メイン画面 --> 会話読み込みダイアログ: 読み込み
    会話読み込みダイアログ --> メイン画面: 読み込み完了
```

## 主要画面の目的

### 1. 起動画面

- **目的**: アプリケーションの初期化と環境確認
- **機能**:
  - Ollamaの実行確認
  - 前回の設定の読み込み
  - 初回起動時の設定ガイド

### 2. 設定画面

- **目的**: アプリケーション全体の設定
- **機能**:
  - ユーザープロファイル設定
  - デフォルトモデル設定
  - デバッグレベル設定
  - テーマ設定

### 3. サーバー接続画面

- **目的**: MCPサーバーとの接続設定
- **機能**:
  - サーバーパス入力
  - 接続パラメータ設定
  - 接続テスト
  - 利用可能なツールの表示

### 4. メイン画面（チャットタブ）

- **目的**: LLMエージェントとの対話
- **機能**:
  - メッセージ入力
  - 会話履歴表示
  - ツール実行の表示
  - 会話の保存/読み込み

### 5. メイン画面（デバッグタブ）

- **目的**: 開発とデバッグ支援
- **機能**:
  - ログ表示と検索
  - メッセージトレース
  - ツールコール履歴
  - エラー情報の表示

### 6. メイン画面（ツールタブ）

- **目的**: 利用可能なツールの管理
- **機能**:
  - ツール一覧表示
  - ツール詳細情報
  - ツール使用統計
  - ツールスキーマ表示

### 7. メイン画面（設定タブ）

- **目的**: 実行時設定の調整
- **機能**:
  - モデル選択
  - パラメータ調整
  - サーバー再接続
  - デバッグ設定

## 重要な意思決定ポイント

アプリケーション内の主要な意思決定ポイントとその選択肢：

```mermaid
flowchart TD
    A[意思決定ポイント] --> B{サーバー接続方法}
    B -->|パスを直接指定| B1[ファイルパス入力]
    B -->|起動済みサーバーに接続| B2[URL入力]
    B -->|新規サーバーを起動| B3[サーバーを選択して起動]
    
    A --> C{モデル選択}
    C -->|既存モデル| C1[インストール済みモデルを選択]
    C -->|新規モデル| C2[モデルをダウンロード]
    
    A --> D{デバッグレベル}
    D -->|通常使用| D1[INFO レベル]
    D -->|問題診断| D2[DEBUG レベル]
    D -->|詳細診断| D3[TRACE レベル]
    
    A --> E{会話管理}
    E -->|会話を保存| E1[ローカルに保存]
    E -->|会話を共有| E2[エクスポート]
    E -->|会話を読み込み| E3[インポート]
    
    style A fill:#bbdefb,stroke:#1976d2
    style B fill:#fff9c4,stroke:#fbc02d
    style C fill:#fff9c4,stroke:#fbc02d
    style D fill:#fff9c4,stroke:#fbc02d
    style E fill:#fff9c4,stroke:#fbc02d
```

## エラーケースと代替フロー

### 1. サーバー接続エラー

サーバーに接続できない場合の代替フロー：

```mermaid
flowchart TD
    A[サーバー接続試行] --> B{接続エラー}
    B --> C[エラー詳細を表示]
    C --> D{エラーの種類}
    
    D -->|ファイルが見つからない| E[ファイルパスを確認するよう促す]
    D -->|実行権限エラー| F[権限設定を確認するよう促す]
    D -->|タイムアウト| G[サーバーが実行中か確認するよう促す]
    D -->|その他| H[詳細エラーログを表示]
    
    E --> I[パスを修正]
    F --> J[権限を修正]
    G --> K[サーバーを起動]
    H --> L[トラブルシューティングガイド表示]
    
    I --> M[再接続]
    J --> M
    K --> M
    L --> M
    
    M --> N{再接続成功?}
    N -->|はい| O[メイン画面に進む]
    N -->|いいえ| C
    
    style B fill:#ffcdd2,stroke:#c62828
    style O fill:#c8e6c9,stroke:#2e7d32
```

### 2. ツール実行エラー

ツール実行中にエラーが発生した場合の処理フロー：

```mermaid
flowchart TD
    A[ツール実行] --> B{実行エラー}
    B --> C[エラー詳細をログに記録]
    C --> D{エラーの種類}
    
    D -->|タイムアウト| E[再試行オプションを提示]
    D -->|権限エラー| F[権限設定ガイドを表示]
    D -->|入力エラー| G[入力修正オプションを提示]
    D -->|その他| H[一般エラーメッセージを表示]
    
    E --> I{再試行する?}
    I -->|はい| J[パラメータを調整して再試行]
    I -->|いいえ| K[エラー情報をモデルに送信]
    
    F --> K
    G --> L[入力を修正]
    L --> A
    H --> K
    
    J --> M{再試行成功?}
    M -->|はい| N[結果をモデルに送信]
    M -->|いいえ| K
    
    K --> O[会話を継続]
    N --> O
    
    style B fill:#ffcdd2,stroke:#c62828
    style K fill:#fff9c4,stroke:#fbc02d
    style N fill:#c8e6c9,stroke:#2e7d32
```

### 3. Ollamaモデル実行エラー

Ollamaモデルの実行中にエラーが発生した場合の処理フロー：

```mermaid
flowchart TD
    A[モデル呼び出し] --> B{モデルエラー}
    B --> C[エラー詳細をログに記録]
    C --> D{エラーの種類}
    
    D -->|モデルが見つからない| E[モデルのダウンロードを提案]
    D -->|リソース不足| F[パラメータ調整を提案]
    D -->|タイムアウト| G[タイムアウト設定調整を提案]
    D -->|その他| H[一般エラーメッセージを表示]
    
    E --> I[モデルをダウンロード]
    I --> J[再試行]
    
    F --> K[パラメータを調整]
    K --> J
    
    G --> L[タイムアウトを延長]
    L --> J
    
    H --> M[トラブルシューティングガイド表示]
    M --> N